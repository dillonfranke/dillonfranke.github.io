<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Java Static Vulnerability Analysis to Increase Your Bounty | Dillon Franke Security</title><meta name=keywords content><meta name=description content="If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply grep-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities."><meta name=author content><link rel=canonical href=https://www.dillonfrankesecurity.com/posts/java-static-vulnerability-analysis-to-increase-your-bounty/><link crossorigin=anonymous href=/assets/css/stylesheet.07a68968f398111005ecf66ad6e7e8c4179654fe623dcb50cb84ed17e057ac15.css integrity="sha256-B6aJaPOYERAF7PZq1ufoxBeWVP5iPctQy4TtF+BXrBU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.dillonfrankesecurity.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.dillonfrankesecurity.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.dillonfrankesecurity.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.dillonfrankesecurity.com/apple-touch-icon.png><link rel=mask-icon href=https://www.dillonfrankesecurity.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=dillonfrankesecurity.com src=https://plausible.io/js/script.js></script><meta property="og:title" content="Java Static Vulnerability Analysis to Increase Your Bounty"><meta property="og:description" content="If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply grep-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities."><meta property="og:type" content="article"><meta property="og:url" content="https://www.dillonfrankesecurity.com/posts/java-static-vulnerability-analysis-to-increase-your-bounty/"><meta property="og:image" content="https://www.dillonfrankesecurity.com/coffee-cup-space.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-03T11:40:07-08:00"><meta property="article:modified_time" content="2023-03-03T11:40:07-08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.dillonfrankesecurity.com/coffee-cup-space.png"><meta name=twitter:title content="Java Static Vulnerability Analysis to Increase Your Bounty"><meta name=twitter:description content="If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply grep-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.dillonfrankesecurity.com/posts/"},{"@type":"ListItem","position":3,"name":"Java Static Vulnerability Analysis to Increase Your Bounty","item":"https://www.dillonfrankesecurity.com/posts/java-static-vulnerability-analysis-to-increase-your-bounty/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Java Static Vulnerability Analysis to Increase Your Bounty","name":"Java Static Vulnerability Analysis to Increase Your Bounty","description":"If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply grep-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities.","keywords":[],"articleBody":"If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply grep-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities. üòà\n1. Choose an Integrated Development Environment (‚ÄùIDE‚Äù) To make our static analysis much more effective, it‚Äôs imperative to leverage a Java IDE. An IDE is essentially a fancy text editor with the superpower of being able to resolve code references to external references such as third party libraries or the Java SDK. In this post, I‚Äôll use the excellent IntelliJ IDEA IDE from JetBrains, although you can use any other Java IDE as well such as Eclipse.\n2. Obtain a Java Package (.jar, .war, or .apk) to Analyze When reverse-engineering a Java application, you will typically obtain a package of Java classes in the form of a .jar, .war, or .apk file. Let‚Äôs take a look at the differences between these file types with this table:\nPackage Type Description Example .jar (‚ÄùJava Archive‚Äù) Packaged Java application or library https://repo1.maven.org/maven2/com/squareup/okio/okio/3.3.0/okio-3.3.0.jar .war (‚ÄùWeb Archive‚Äù) Packaged Java web application http://www.opencms.org/en/download/ .apk (‚ÄùAndroid Package‚Äù) Packaged Android application https://play.google.com/store/apps/details?id=no.mobitroll.kahoot.android\u0026gl=US 3. Unpack the Java Package and Obtain .jar Files The next step is to obtain .jar files from our original Java package. This process will vary slightly depending on the type of package you are analyzing.\nGetting .jar Files From a.jar File If you are analyzing a .jar file, you are ready to decompile! That was easy, move on to the next section üôÇ\nGetting .jar Files From a .war File A .war file is really just a .zip archive, so we can unpack it using the unzip or jar utility:\n‚ùØ jar xvf opencms.war created: META-INF/ inflated: META-INF/MANIFEST.MF created: WEB-INF/ inflated: WEB-INF/cmsshell.sh created: WEB-INF/setupdata/ created: WEB-INF/setupdata/database/ created: WEB-INF/setupdata/database/db2/ inflated: WEB-INF/setupdata/database/db2/create_db.sql inflated: WEB-INF/setupdata/database/db2/drop_db.sql inflated: WEB-INF/setupdata/database/db2/drop_tables.sql inflated: WEB-INF/setupdata/database/db2/create_tables.sql created: WEB-INF/setupdata/database/oracle/ inflated: WEB-INF/setupdata/database/oracle/create_db.sql inflated: WEB-INF/setupdata/database/oracle/drop_db.sql inflated: WEB-INF/setupdata/database/oracle/drop_tables.sql inflated: WEB-INF/setupdata/database/oracle/create_tables.sql # Truncated for brevity... A quick find command will show us where all the .jar files are hanging out:\n‚ùØ find . -name \"*.jar\" ./WEB-INF/lib/avatica-core-1.17.0.jar ./WEB-INF/lib/jetty-util-9.4.31.v20200723.jar ./WEB-INF/lib/opencms-setup.jar ./WEB-INF/lib/xercesImpl-2.12.0.jar ./WEB-INF/lib/solr-solrj-8.11.1.jar ./WEB-INF/lib/saaj-impl-1.3.28.jar ./WEB-INF/lib/cssparser-0.9.25.jar ./WEB-INF/lib/org.opencms.locale.it.jar ./WEB-INF/lib/htmlparser-2.1.jar ./WEB-INF/lib/commons-logging-1.2.jar ./WEB-INF/lib/org.opencms.locale.de.jar ./WEB-INF/lib/openpdf-1.3.20.jar ./WEB-INF/lib/poi-ooxml-schemas-4.1.2.jar ./WEB-INF/lib/gwt-elemental-2.9.0.jar ./WEB-INF/lib/alkacon.mercury.xtensions.jar ./WEB-INF/lib/commons-pool2-2.8.1.jar ./WEB-INF/lib/hppc-0.8.2.jar ./WEB-INF/lib/gson-2.8.6.jar # Truncated for brevity... But a lot of these .jar files look like third party libraries that we might not want to spend time decompiling, at least not initially. We want to find the main logic implemented by the developers of the application we‚Äôre looking at to make the best use of our time.\nTo do this, I always check out the web.xml file, which should be in the WEB-INF/ directory. This file is used by Java application servers to determine which classes to route traffic to. For example, the figure below shows a few interesting classes implementing servlets for the OpenCMS application. From what I‚Äôm seeing here, the org.opencms package is looking like a great place to start analyzing.\nThe error handling servlet, also serves as trigger for static export requests. OpenCmsServletErrorHandler org.opencms.main.OpenCmsServletErrorHandler 0 The main servlet that handles all requests to the OpenCms VFS. OpenCmsServlet org.opencms.main.OpenCmsServlet 1 Now, we can use a simple grep to identify .jar files that implement the classes we care about. These matched .jar files seem like great candidates for handling the application‚Äôs main logic\n‚ùØ grep -ir org.opencms WEB-INF/lib Binary file WEB-INF/lib/opencms-setup.jar matches Binary file WEB-INF/lib/org.opencms.locale.it.jar matches Binary file WEB-INF/lib/org.opencms.locale.de.jar matches Binary file WEB-INF/lib/org.opencms.locale.da.jar matches Binary file WEB-INF/lib/org.opencms.locale.es.jar matches Binary file WEB-INF/lib/org.opencms.locale.cs.jar matches Binary file WEB-INF/lib/org.opencms.locale.zh.jar matches Binary file WEB-INF/lib/opencms.jar matches Binary file WEB-INF/lib/opencms-resources.jar matches Binary file WEB-INF/lib/org.opencms.locale.ru.jar matches Binary file WEB-INF/lib/org.opencms.locale.ja.jar matches Binary file WEB-INF/lib/opencms-modules.jar matches Next, let‚Äôs move those .jar files to a separate directory, since we‚Äôll focus on decompiling them first.\n‚ùØ mkdir jars-we-care-about \u0026\u0026 grep -ir org.opencms WEB-INF/lib | awk '{print $3}' | xargs -I{} cp {} jars-we-care-about And we‚Äôve extracted the .jar files from our .war file! Let‚Äôs see how to do it with an .apk file, and then we‚Äôre ready to decompile.\nGetting .jar Files From an .apk File Getting JARs from an .apk file is a bit different because Android applications utilize the Dalvik Executable (‚ÄùDEX‚Äù) format to package Java classes and resources instead of JAR. However, the classes are compiled into the same (mostly, Dalvik bytecode is more optimized) bytecode. So, we can transform a .dex to a .jar file quite easily.\nWe can use unzip or jar once again to unpack the application and identify the .dex files within an .apk file. The figure below shows us identifying two .dex files for the Kahoot android application.\n‚ùØ jar xvf no.mobitroll.kahoot.android.apk inflated: classes.dex # Dex file inflated: classes2.dex # Dex file inflated: lib/arm64-v8a/libpruneau.so inflated: lib/armeabi-v7a/libpruneau.so inflated: lib/x86/libpruneau.so inflated: lib/x86_64/libpruneau.so extracted: assets/audio/TheEnd.mp3 extracted: assets/audio/alt02-answer_010sec.mp3 extracted: assets/audio/alt02-answer_020sec.mp3 extracted: assets/audio/alt02-answer_030sec.mp3 extracted: assets/audio/alt03-answer_010sec.mp3 extracted: assets/audio/alt03-answer_020sec.mp3 extracted: assets/audio/alt03-answer_030sec.mp3 extracted: assets/audio/alt03-answer_060sec.mp3 extracted: assets/audio/alt03-answer_090sec.mp3 extracted: assets/audio/alt03-answer_120sec.mp3 extracted: assets/audio/answer_10sec.mp3 extracted: assets/audio/answer_20sec.mp3 extracted: assets/audio/answer_30sec.mp3 extracted: assets/audio/content_slide_underscore.mp3 extracted: assets/audio/correct_01.mp3 Next, we can use the dex2jar utility to convert the .dex files to .jar files:\n‚ùØ d2j-dex2jar classes* dex2jar classes.dex -\u003e ./classes-dex2jar.jar dex2jar classes2.dex -\u003e ./classes2-dex2jar.jar 4. Decompile the .jar Files With our desired .jar files in hand, it‚Äôs time to decompile them! IntelliJ comes with a great decompiler that you can call from the command line. Here‚Äôs how to do it on Mac:\n‚ùØ mkdir decompiled-jars-we-care-about # Make a new dir for decompiled jars ‚ùØ java -Xmx7066M -cp /Applications/IntelliJ\\ IDEA\\ CE.app/Contents/plugins/java-decompiler/lib/java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -mpm=3 jars-we-care-about decompiled-jars-we-care-about INFO: Decompiling class org/opencms/module/CmsModuleDependency INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleImportExportRepository INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleUpdater INFO: ... done INFO: Decompiling class org/opencms/module/CmsResourceImportData INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleVersion INFO: ... done INFO: Decompiling class org/opencms/module/CmsReplaceModuleInfo INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleXmlHandler INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleManager INFO: ... done INFO: Decompiling class org/opencms/module/CmsModule INFO: ... done INFO: Decompiling class org/opencms/module/Messages INFO: ... done INFO: Decompiling class org/opencms/module/CmsModuleImportData # Truncated for brevity... Now, we can unpack the decompiled .jar files to reveal the decompiled Java source code inside!\n‚ùØ cd decompiled-jars-we-care-about ‚ùØ find . -name \"*.jar\" | xargs -I{} jar xvf {} # Unpack all the decompiled JARs inflated: META-INF/MANIFEST.MF created: META-INF/ created: org/ created: org/opencms/ created: org/opencms/setup/ created: org/opencms/setup/ui/ created: org/opencms/setup/db/ created: org/opencms/setup/db/update6to7/ created: org/opencms/setup/db/update6to7/oracle/ created: org/opencms/setup/db/update6to7/postgresql/ created: org/opencms/setup/db/update6to7/mysql/ created: org/opencms/setup/db/update7to8/ created: org/opencms/setup/db/update7to8/oracle/ created: org/opencms/setup/db/update7to8/postgresql/ created: org/opencms/setup/db/update7to8/mysql/ created: org/opencms/setup/updater/ created: org/opencms/setup/updater/dialogs/ created: org/opencms/setup/xml/ created: org/opencms/setup/comptest/ inflated: org/opencms/setup/ui/CmsSetupStep02ComponentCheck.html inflated: org/opencms/setup/ui/CmsSetupErrorDialog.html inflated: org/opencms/setup/ui/CmsSetupStep03Database.html inflated: org/opencms/setup/ui/CmsSetupStep01License.html inflated: org/opencms/setup/ui/CmsSetupStep06ImportReport.html inflated: org/opencms/setup/ui/CmsSetupStep07ConfigNotes.html inflated: org/opencms/setup/ui/CmsSetupStep05ServerSettings.html inflated: org/opencms/setup/ui/CmsSetupStep04Modules.html inflated: org/opencms/setup/ui/CmsDbSettingsPanel.html # Truncated for brevity... We‚Äôre left with .java source files!\n‚ùØ find . -name \"*.java\" ./org/opencms/cmis/CmsCmisTypeManager.java ./org/opencms/cmis/I_CmsCmisObjectHelper.java ./org/opencms/cmis/CmsCmisService.java ./org/opencms/cmis/A_CmsCmisRepository.java ./org/opencms/cmis/I_CmsCmisRenditionProvider.java ./org/opencms/cmis/CmsCmisCallContext.java ./org/opencms/cmis/I_CmsCmisRepository.java ./org/opencms/cmis/CmsCmisRelationHelper.java ./org/opencms/cmis/CmsObjectListLimiter.java ./org/opencms/cmis/CmsCmisResourceHelper.java ./org/opencms/cmis/CmsCmisServiceFactory.java ./org/opencms/cmis/CmsCmisRenditionFilter.java ./org/opencms/cmis/I_CmsPropertyProvider.java ./org/opencms/cmis/CmsCmisUtil.java ./org/opencms/cmis/CmsCmisRepository.java ./org/opencms/ui/I_CmsHasButtons.java ./org/opencms/ui/I_CmsEditPropertyContext.java ./org/opencms/ui/I_CmsUpdateListener.java ./org/opencms/ui/CmsVaadinErrorHandler.java ./org/opencms/ui/CmsUserIconHelper.java ./org/opencms/ui/util/CmsComboNullToEmptyConverter.java ./org/opencms/ui/util/CmsStyleVariable.java ./org/opencms/ui/util/CmsLogicalCheckboxGroup.java ./org/opencms/ui/util/CmsDisplayType.java ./org/opencms/ui/util/CmsNewResourceBuilder.java # Truncated for brevity... 5. Set Up Your IDE Now that we have (basically) Java source code, it‚Äôs time to load it into our IDE and start finding vulnerabilities.\nOpen Your Decompiled Java Code First, fire up IntelliJ and click Open.\nNow, select the directory of decompiled and expanded .jar files we created.\nResolve Dependencies This is where the true magic happens. We‚Äôre going to point IntelliJ to the original .jar files we extracted, (not the decompiled ones) and it is going to allow us to resolve the application‚Äôs dependencies to perform in-depth static analysis.\nGo to File ‚Üí Project Structure‚Ä¶ and, firstly, select a Java SDK that makes sense for the project you‚Äôre analyzing. Be sure to click Apply.\nNext, go the Libraries tab and click - to remove any current dependencies, as these are decompiled .jars and won‚Äôt resolve things properly.\nClick + to add a new project library and choose Java:\nSelect the folder containing the original, compiled .jar files. Include the third party dependencies, we want to be able to resolve them too!\nHit Apply and then OK.\nAdditional Unresolved Dependencies It‚Äôs possible that after adding all the original .jars as libraries, you‚Äôll still have some unresolved dependencies within your project. These will show up red within IntelliJ.\nThis is likely because the application you are analyzing assumes that the system running it will have these dependencies on its class path already. For example, an Android APK should expect the Android SDK to be present, and a web application should expect the javax.servlet package to be present.\nSometimes, you can resolve these dependencies quickly by clicking on the red lightbulb within IntelliJ and then Find JAR on web.\nOtherwise, you can navigate back to File ‚Üí Project Structure‚Ä¶ and add a new library from Maven (the Java package manager).\nSearch for and select the dependency you need to resolve. IntelliJ will download the .jar from Maven and add it to your project.\n6. Profit! I know it took a bit to get here, but by investing time up front, you are now prepared to find vulnerabilities that simply wouldn‚Äôt be possible otherwise.\nFinding Usages One of the pain points of manual static analysis is the tedious process of tracing user-controllable input through the application. Well, with our current setup, we have made our lives much easier. We can click on any variable, method, or class and find all of its assignments and usages throughout the application. For example, we might want to understand how the class variable m_settings is being used throughout the application:\nIntelliJ‚Äôs ability to map out all read and write occurrences of a variable in question greatly speeds up manual static analysis.\nData Flow Analysis IntelliJ goes behind just finding usages, though. It can fully map out the flow of data within the application. To do this, we right click on a variable and go to Analyze ‚Üí Data Flow to Here‚Ä¶ or Data Flow from Here‚Ä¶ Below, we are doing this to understand how the req variable of the doGet() method of an HTTP servlet is being used.\nWe can then easily view all the places the req variable is passed into other functions within the rest of the application in one single place. This is extremely useful during static analysis.\nSink-to-Source Analysis With these tools under our belt, we have to ability to find truly impactful vulnerabilities. We can leverage source-to-sink analysis, (also called taint analysis) where we trace the flow of data from dangerous functions back to parameters we control. For a more in-depth definition of source-to-sink analysis, check out one of my previous blog posts: https://www.mandiant.com/resources/blog/route-sixty-sink-launch.\nFor example, let‚Äôs say we want to look for unsafe deserialization vulnerabilities (they just so happen to be one of my favorite vulnerability classes). We know that a call to java.io.ObjectInputStream::ReadObject() on attacker-controlled data can result in SSRF, file access, or even remote code execution. Let‚Äôs see how to search for Java object deserialization within our application:\nFirst, enter ‚åò + O and search for the java.io.ObjectInputStream class:\nIdentify the readObject() method and view its data flow throughout the application:\nWe immediately have a detailed call graph leading to our sink. If we can trace it to input that we control as an attacker, (an HTTP parameter, header, etc.) we‚Äôve found a vulnerability!\nThanks for reading! Keep an eye out for more security content coming your way soon! Stay safe out there! üîíüíªüë®‚Äçüíª\n","wordCount":"1902","inLanguage":"en","image":"https://www.dillonfrankesecurity.com/coffee-cup-space.png","datePublished":"2023-03-03T11:40:07-08:00","dateModified":"2023-03-03T11:40:07-08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.dillonfrankesecurity.com/posts/java-static-vulnerability-analysis-to-increase-your-bounty/"},"publisher":{"@type":"Organization","name":"Dillon Franke Security","logo":{"@type":"ImageObject","url":"https://www.dillonfrankesecurity.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.dillonfrankesecurity.com accesskey=h title="Dillon Franke Security (Alt + H)">Dillon Franke Security</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.dillonfrankesecurity.com/ title=Home><span>Home</span></a></li><li><a href=https://www.dillonfrankesecurity.com/posts title=Blog><span>Blog</span></a></li><li><a href=https://www.dillonfrankesecurity.com/presentations title=Presentations><span>Presentations</span></a></li><li><a href=https://www.dillonfrankesecurity.com/services title=Services><span>Services</span></a></li><li><a href=https://www.dillonfrankesecurity.com/contact title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Java Static Vulnerability Analysis to Increase Your Bounty</h1><div class=post-meta><span title='2023-03-03 11:40:07 -0800 -0800'>March 3, 2023</span>&nbsp;¬∑&nbsp;9 min</div></header><figure class=entry-cover><img loading=lazy src=https://www.dillonfrankesecurity.com/coffee-cup-space.png alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-choose-an-integrated-development-environment-ide aria-label="1. Choose an Integrated Development Environment (‚ÄùIDE‚Äù)">1. Choose an Integrated Development Environment (‚ÄùIDE‚Äù)</a></li><li><a href=#2-obtain-a-java-package-jar-war-or-apk-to-analyze aria-label="2. Obtain a Java Package (.jar, .war, or .apk) to Analyze">2. Obtain a Java Package (<code>.jar</code>, <code>.war</code>, or <code>.apk</code>) to Analyze</a></li><li><a href=#3-unpack-the-java-package-and-obtain-jar-files aria-label="3. Unpack the Java Package and Obtain .jar Files">3. Unpack the Java Package and Obtain <code>.jar</code> Files</a><ul><li><a href=#getting-jar-files-from-ajar-file aria-label="Getting .jar Files From a.jar File">Getting <code>.jar</code> Files From a<code>.jar</code> File</a></li><li><a href=#getting-jar-files-from-a--war-file aria-label="Getting .jar Files From a .war File">Getting <code>.jar</code> Files From a <code>.war</code> File</a></li><li><a href=#getting-jar-files-from-an-apk-file aria-label="Getting .jar Files From an .apk File">Getting <code>.jar</code> Files From an <code>.apk</code> File</a></li></ul></li><li><a href=#4-decompile-the-jar-files aria-label="4. Decompile the .jar Files">4. Decompile the <code>.jar</code> Files</a></li><li><a href=#5-set-up-your-ide aria-label="5. Set Up Your IDE">5. Set Up Your IDE</a><ul><li><a href=#open-your-decompiled-java-code aria-label="Open Your Decompiled Java Code">Open Your Decompiled Java Code</a></li><li><a href=#resolve-dependencies aria-label="Resolve Dependencies">Resolve Dependencies</a></li><li><a href=#additional-unresolved-dependencies aria-label="Additional Unresolved Dependencies">Additional Unresolved Dependencies</a></li></ul></li><li><a href=#6-profit aria-label="6. Profit!">6. Profit!</a><ul><li><a href=#finding-usages aria-label="Finding Usages">Finding Usages</a></li><li><a href=#data-flow-analysis aria-label="Data Flow Analysis">Data Flow Analysis</a></li><li><a href=#sink-to-source-analysis aria-label="Sink-to-Source Analysis">Sink-to-Source Analysis</a></li></ul></li></ul></div></details></div><div class=post-content><p>If you want to get serious about finding impactful vulnerabilities through static analysis, it‚Äôs time to move beyond simply <code>grep</code>-ing through code bases. In this blog post, I‚Äôll share my personal process for setting up a robust environment for Java static analysis of console applications, web applications, and Android applications. Once you‚Äôve established this test environment, you‚Äôll be able to take advantage of automatic code references, trace usages across a code base, and leverage source-to-sink analysis to find elusive vulnerabilities. üòà</p><h2 id=1-choose-an-integrated-development-environment-ide>1. Choose an Integrated Development Environment (‚ÄùIDE‚Äù)<a hidden class=anchor aria-hidden=true href=#1-choose-an-integrated-development-environment-ide>#</a></h2><p>To make our static analysis <em><strong><strong><strong><strong><strong><strong><strong>much</strong></strong></strong></strong></strong></strong></strong></em> more effective, it‚Äôs imperative to leverage a Java IDE. An IDE is essentially a fancy text editor with the superpower of being able to resolve code references to external references such as third party libraries or the Java SDK. In this post, I‚Äôll use the excellent <a href=https://www.jetbrains.com/idea/>IntelliJ IDEA IDE</a> from JetBrains, although you can use any other Java IDE as well such as Eclipse.</p><h2 id=2-obtain-a-java-package-jar-war-or-apk-to-analyze>2. Obtain a Java Package (<code>.jar</code>, <code>.war</code>, or <code>.apk</code>) to Analyze<a hidden class=anchor aria-hidden=true href=#2-obtain-a-java-package-jar-war-or-apk-to-analyze>#</a></h2><p>When reverse-engineering a Java application, you will typically obtain a package of Java classes in the form of a <code>.jar</code>, <code>.war</code>, or <code>.apk</code> file. Let‚Äôs take a look at the differences between these file types with this table:</p><table><thead><tr><th>Package Type</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td><code>.jar</code> (‚ÄùJava Archive‚Äù)</td><td>Packaged Java application or library</td><td><a href=https://repo1.maven.org/maven2/com/squareup/okio/okio/3.3.0/okio-3.3.0.jar>https://repo1.maven.org/maven2/com/squareup/okio/okio/3.3.0/okio-3.3.0.jar</a></td></tr><tr><td><code>.war</code> (‚ÄùWeb Archive‚Äù)</td><td>Packaged Java web application</td><td><a href=http://www.opencms.org/en/download/>http://www.opencms.org/en/download/</a></td></tr><tr><td><code>.apk</code> (‚ÄùAndroid Package‚Äù)</td><td>Packaged Android application</td><td><a href="https://play.google.com/store/apps/details?id=no.mobitroll.kahoot.android&amp;gl=US">https://play.google.com/store/apps/details?id=no.mobitroll.kahoot.android&amp;gl=US</a></td></tr></tbody></table><h2 id=3-unpack-the-java-package-and-obtain-jar-files>3. Unpack the Java Package and Obtain <code>.jar</code> Files<a hidden class=anchor aria-hidden=true href=#3-unpack-the-java-package-and-obtain-jar-files>#</a></h2><p>The next step is to obtain <code>.jar</code> files from our original Java package. This process will vary slightly depending on the type of package you are analyzing.</p><h3 id=getting-jar-files-from-ajar-file>Getting <code>.jar</code> Files From a<code>.jar</code> File<a hidden class=anchor aria-hidden=true href=#getting-jar-files-from-ajar-file>#</a></h3><p>If you are analyzing a <code>.jar</code> file, you are ready to decompile! That was easy, move on to the next section üôÇ</p><h3 id=getting-jar-files-from-a--war-file>Getting <code>.jar</code> Files From a <code>.war</code> File<a hidden class=anchor aria-hidden=true href=#getting-jar-files-from-a--war-file>#</a></h3><p>A <code>.war</code> file is really just a <code>.zip</code> archive, so we can unpack it using the <code>unzip</code> or <code>jar</code> utility:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ jar xvf opencms.war
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>created: META-INF/
</span></span><span style=display:flex><span>inflated: META-INF/MANIFEST.MF
</span></span><span style=display:flex><span>created: WEB-INF/
</span></span><span style=display:flex><span>inflated: WEB-INF/cmsshell.sh
</span></span><span style=display:flex><span>created: WEB-INF/setupdata/
</span></span><span style=display:flex><span>created: WEB-INF/setupdata/database/
</span></span><span style=display:flex><span>created: WEB-INF/setupdata/database/db2/
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/db2/create_db.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/db2/drop_db.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/db2/drop_tables.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/db2/create_tables.sql
</span></span><span style=display:flex><span>created: WEB-INF/setupdata/database/oracle/
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/oracle/create_db.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/oracle/drop_db.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/oracle/drop_tables.sql
</span></span><span style=display:flex><span>inflated: WEB-INF/setupdata/database/oracle/create_tables.sql
</span></span><span style=display:flex><span><span style=color:#75715e># Truncated for brevity...</span>
</span></span></code></pre></div><p>A quick <code>find</code> command will show us where all the <code>.jar</code> files are hanging out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ find . -name <span style=color:#e6db74>&#34;*.jar&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./WEB-INF/lib/avatica-core-1.17.0.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/jetty-util-9.4.31.v20200723.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/opencms-setup.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/xercesImpl-2.12.0.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/solr-solrj-8.11.1.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/saaj-impl-1.3.28.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/cssparser-0.9.25.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/org.opencms.locale.it.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/htmlparser-2.1.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/commons-logging-1.2.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/org.opencms.locale.de.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/openpdf-1.3.20.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/poi-ooxml-schemas-4.1.2.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/gwt-elemental-2.9.0.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/alkacon.mercury.xtensions.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/commons-pool2-2.8.1.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/hppc-0.8.2.jar
</span></span><span style=display:flex><span>./WEB-INF/lib/gson-2.8.6.jar
</span></span><span style=display:flex><span><span style=color:#75715e># Truncated for brevity...</span>
</span></span></code></pre></div><p>But a lot of these <code>.jar</code> files look like third party libraries that we might not want to spend time decompiling, at least not initially. We want to find the main logic implemented by the developers of the application we‚Äôre looking at to make the best use of our time.</p><p>To do this, I always check out the <code>web.xml</code> file, which should be in the <code>WEB-INF/</code> directory. This file is used by Java application servers to determine which classes to route traffic to. For example, the figure below shows a few interesting classes implementing servlets for the OpenCMS application. From what I‚Äôm seeing here, the <code>org.opencms</code> package is looking like a great place to start analyzing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- Truncated for brevity ---&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;servlet&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;description&gt;</span>
</span></span><span style=display:flex><span>        The error handling servlet, also serves as trigger for static export requests.
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;servlet-name&gt;</span>OpenCmsServletErrorHandler<span style=color:#f92672>&lt;/servlet-name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;servlet-class&gt;</span>org.opencms.main.OpenCmsServletErrorHandler<span style=color:#f92672>&lt;/servlet-class&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;load-on-startup&gt;</span>0<span style=color:#f92672>&lt;/load-on-startup&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/servlet&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;servlet&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;description&gt;</span>
</span></span><span style=display:flex><span>        The main servlet that handles all requests to the OpenCms VFS.
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;servlet-name&gt;</span>OpenCmsServlet<span style=color:#f92672>&lt;/servlet-name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;servlet-class&gt;</span>org.opencms.main.OpenCmsServlet<span style=color:#f92672>&lt;/servlet-class&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;load-on-startup&gt;</span>1<span style=color:#f92672>&lt;/load-on-startup&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/servlet&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- Truncated for brevity ---&gt;</span>
</span></span></code></pre></div><p>Now, we can use a simple grep to identify <code>.jar</code> files that implement the classes we care about. These matched <code>.jar</code> files seem like great candidates for handling the application‚Äôs main logic</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ grep -ir org.opencms WEB-INF/lib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/opencms-setup.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.it.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.de.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.da.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.es.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.cs.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.zh.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/opencms.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/opencms-resources.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.ru.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/org.opencms.locale.ja.jar matches
</span></span><span style=display:flex><span>Binary file WEB-INF/lib/opencms-modules.jar matches
</span></span></code></pre></div><p>Next, let‚Äôs move those <code>.jar</code> files to a separate directory, since we‚Äôll focus on decompiling them first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ mkdir jars-we-care-about <span style=color:#f92672>&amp;&amp;</span> grep -ir org.opencms WEB-INF/lib | awk <span style=color:#e6db74>&#39;{print $3}&#39;</span> | xargs -I<span style=color:#f92672>{}</span> cp <span style=color:#f92672>{}</span> jars-we-care-about
</span></span></code></pre></div><p>And we‚Äôve extracted the <code>.jar</code> files from our <code>.war</code> file! Let‚Äôs see how to do it with an <code>.apk</code> file, and then we‚Äôre ready to decompile.</p><h3 id=getting-jar-files-from-an-apk-file>Getting <code>.jar</code> Files From an <code>.apk</code> File<a hidden class=anchor aria-hidden=true href=#getting-jar-files-from-an-apk-file>#</a></h3><p>Getting JARs from an <code>.apk</code> file is a bit different because Android applications utilize the Dalvik Executable (‚ÄùDEX‚Äù) format to package Java classes and resources instead of JAR. However, the classes are compiled into the same (mostly, Dalvik bytecode is more optimized) bytecode. So, we can transform a <code>.dex</code> to a <code>.jar</code> file quite easily.</p><p>We can use <code>unzip</code> or <code>jar</code> once again to unpack the application and identify the <code>.dex</code> files within an <code>.apk</code> file. The figure below shows us identifying two <code>.dex</code> files for the Kahoot android application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ jar xvf no.mobitroll.kahoot.android.apk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>inflated: classes.dex   <span style=color:#75715e># Dex file</span>
</span></span><span style=display:flex><span>inflated: classes2.dex  <span style=color:#75715e># Dex file</span>
</span></span><span style=display:flex><span>inflated: lib/arm64-v8a/libpruneau.so
</span></span><span style=display:flex><span>inflated: lib/armeabi-v7a/libpruneau.so
</span></span><span style=display:flex><span>inflated: lib/x86/libpruneau.so
</span></span><span style=display:flex><span>inflated: lib/x86_64/libpruneau.so
</span></span><span style=display:flex><span>extracted: assets/audio/TheEnd.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt02-answer_010sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt02-answer_020sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt02-answer_030sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_010sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_020sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_030sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_060sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_090sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/alt03-answer_120sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/answer_10sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/answer_20sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/answer_30sec.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/content_slide_underscore.mp3
</span></span><span style=display:flex><span>extracted: assets/audio/correct_01.mp3
</span></span></code></pre></div><p>Next, we can use the <code>dex2jar</code> <a href=https://github.com/pxb1988/dex2jar>utility</a> to convert the <code>.dex</code> files to <code>.jar</code> files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ d2j-dex2jar classes*
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>dex2jar classes.dex -&gt; ./classes-dex2jar.jar 
</span></span><span style=display:flex><span>dex2jar classes2.dex -&gt; ./classes2-dex2jar.jar
</span></span></code></pre></div><h2 id=4-decompile-the-jar-files>4. Decompile the <code>.jar</code> Files<a hidden class=anchor aria-hidden=true href=#4-decompile-the-jar-files>#</a></h2><p>With our desired <code>.jar</code> files in hand, it‚Äôs time to decompile them! IntelliJ comes with a great decompiler that you can call from the command line. Here‚Äôs how to do it on Mac:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ mkdir decompiled-jars-we-care-about <span style=color:#75715e># Make a new dir for decompiled jars</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ java -Xmx7066M -cp /Applications/IntelliJ<span style=color:#ae81ff>\ </span>IDEA<span style=color:#ae81ff>\ </span>CE.app/Contents/plugins/java-decompiler/lib/java-decompiler.jar org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler -mpm<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> jars-we-care-about decompiled-jars-we-care-about
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleDependency
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleImportExportRepository
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleUpdater
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsResourceImportData
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleVersion
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsReplaceModuleInfo
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleXmlHandler
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleManager
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModule
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/Messages
</span></span><span style=display:flex><span>INFO:  ... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>INFO:  Decompiling class org/opencms/module/CmsModuleImportData
</span></span><span style=display:flex><span><span style=color:#75715e># Truncated for brevity...</span>
</span></span></code></pre></div><p>Now, we can unpack the decompiled <code>.jar</code> files to reveal the decompiled Java source code inside!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ cd decompiled-jars-we-care-about
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ find . -name <span style=color:#e6db74>&#34;*.jar&#34;</span> | xargs -I<span style=color:#f92672>{}</span> jar xvf <span style=color:#f92672>{}</span>  <span style=color:#75715e># Unpack all the decompiled JARs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>inflated: META-INF/MANIFEST.MF
</span></span><span style=display:flex><span>created: META-INF/
</span></span><span style=display:flex><span>created: org/
</span></span><span style=display:flex><span>created: org/opencms/
</span></span><span style=display:flex><span>created: org/opencms/setup/
</span></span><span style=display:flex><span>created: org/opencms/setup/ui/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update6to7/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update6to7/oracle/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update6to7/postgresql/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update6to7/mysql/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update7to8/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update7to8/oracle/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update7to8/postgresql/
</span></span><span style=display:flex><span>created: org/opencms/setup/db/update7to8/mysql/
</span></span><span style=display:flex><span>created: org/opencms/setup/updater/
</span></span><span style=display:flex><span>created: org/opencms/setup/updater/dialogs/
</span></span><span style=display:flex><span>created: org/opencms/setup/xml/
</span></span><span style=display:flex><span>created: org/opencms/setup/comptest/
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep02ComponentCheck.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupErrorDialog.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep03Database.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep01License.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep06ImportReport.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep07ConfigNotes.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep05ServerSettings.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsSetupStep04Modules.html
</span></span><span style=display:flex><span>inflated: org/opencms/setup/ui/CmsDbSettingsPanel.html
</span></span><span style=display:flex><span><span style=color:#75715e># Truncated for brevity...</span>
</span></span></code></pre></div><p>We‚Äôre left with <code>.java</code> source files!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>‚ùØ find . -name <span style=color:#e6db74>&#34;*.java&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisTypeManager.java
</span></span><span style=display:flex><span>./org/opencms/cmis/I_CmsCmisObjectHelper.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisService.java
</span></span><span style=display:flex><span>./org/opencms/cmis/A_CmsCmisRepository.java
</span></span><span style=display:flex><span>./org/opencms/cmis/I_CmsCmisRenditionProvider.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisCallContext.java
</span></span><span style=display:flex><span>./org/opencms/cmis/I_CmsCmisRepository.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisRelationHelper.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsObjectListLimiter.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisResourceHelper.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisServiceFactory.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisRenditionFilter.java
</span></span><span style=display:flex><span>./org/opencms/cmis/I_CmsPropertyProvider.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisUtil.java
</span></span><span style=display:flex><span>./org/opencms/cmis/CmsCmisRepository.java
</span></span><span style=display:flex><span>./org/opencms/ui/I_CmsHasButtons.java
</span></span><span style=display:flex><span>./org/opencms/ui/I_CmsEditPropertyContext.java
</span></span><span style=display:flex><span>./org/opencms/ui/I_CmsUpdateListener.java
</span></span><span style=display:flex><span>./org/opencms/ui/CmsVaadinErrorHandler.java
</span></span><span style=display:flex><span>./org/opencms/ui/CmsUserIconHelper.java
</span></span><span style=display:flex><span>./org/opencms/ui/util/CmsComboNullToEmptyConverter.java
</span></span><span style=display:flex><span>./org/opencms/ui/util/CmsStyleVariable.java
</span></span><span style=display:flex><span>./org/opencms/ui/util/CmsLogicalCheckboxGroup.java
</span></span><span style=display:flex><span>./org/opencms/ui/util/CmsDisplayType.java
</span></span><span style=display:flex><span>./org/opencms/ui/util/CmsNewResourceBuilder.java
</span></span><span style=display:flex><span><span style=color:#75715e># Truncated for brevity...</span>
</span></span></code></pre></div><h2 id=5-set-up-your-ide>5. Set Up Your IDE<a hidden class=anchor aria-hidden=true href=#5-set-up-your-ide>#</a></h2><p>Now that we have (basically) Java source code, it‚Äôs time to load it into our IDE and start finding vulnerabilities.</p><h3 id=open-your-decompiled-java-code>Open Your Decompiled Java Code<a hidden class=anchor aria-hidden=true href=#open-your-decompiled-java-code>#</a></h3><p>First, fire up IntelliJ and click <strong><strong><strong><strong><strong>Open.</strong></strong></strong></strong></strong></p><p><img loading=lazy src=/opening-a-project-in-intellij.png alt="Opening a Project in IntelliJ"></p><p>Now, select the directory of decompiled and expanded <code>.jar</code> files we created.</p><p><img loading=lazy src=/selecting-jar-files-in-intellij.png alt="Selecting JAR Files in IntelliJ"></p><h3 id=resolve-dependencies>Resolve Dependencies<a hidden class=anchor aria-hidden=true href=#resolve-dependencies>#</a></h3><p>This is where <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>the true magic happens</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>. We‚Äôre going to point IntelliJ to the original <code>.jar</code> files we extracted, (not the decompiled ones) and it is going to allow us to resolve the application‚Äôs dependencies to perform in-depth static analysis.</p><p>Go to <strong><strong><strong><strong><strong><strong><strong><strong><strong>File ‚Üí Project Structure‚Ä¶</strong></strong></strong></strong></strong></strong></strong></strong></strong> and, firstly, select a Java SDK that makes sense for the project you‚Äôre analyzing. Be sure to click <strong><strong><strong><strong><strong>Apply</strong></strong></strong></strong></strong>.</p><p><img loading=lazy src=/selecting-java-sdk.png alt="Selecting Java SDK"></p><p>Next, go the <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Libraries</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> tab and click <strong><strong>-</strong></strong> to remove any current dependencies, as these are decompiled <code>.jar</code>s and won‚Äôt resolve things properly.</p><p><img loading=lazy src=/deselecting-decompiled-jars.png alt="Deselecting Decompiled JARs"></p><p>Click <strong><strong>+</strong></strong> to add a new project library and choose <strong><strong><strong><strong>Java</strong></strong></strong></strong>:</p><p><img loading=lazy src=/adding-new-project-library.png alt="Adding New Project Library"></p><p>Select the folder containing the original, compiled <code>.jar</code> files. Include the third party dependencies, we want to be able to resolve them too!</p><p><img loading=lazy src=/resolving-dependencies.png alt="Resolving Dependencies"></p><p>Hit <strong><strong><strong><strong><strong><strong>Apply</strong></strong></strong></strong></strong></strong> and then <strong><strong><strong>OK</strong></strong></strong>.</p><p><img loading=lazy src=/apply-and-ok.png alt="Apply and Ok"></p><h3 id=additional-unresolved-dependencies>Additional Unresolved Dependencies<a hidden class=anchor aria-hidden=true href=#additional-unresolved-dependencies>#</a></h3><p>It‚Äôs possible that after adding all the original <code>.jar</code>s as libraries, you‚Äôll still have some unresolved dependencies within your project. These will show up red within IntelliJ.</p><p><img loading=lazy src=/broken-dependencies.png alt="Broken Dependencies"></p><p>This is likely because the application you are analyzing assumes that the system running it will have these dependencies on its class path already. For example, an Android APK should expect the Android SDK to be present, and a web application should expect the <code>javax.servlet</code> package to be present.</p><p>Sometimes, you can resolve these dependencies quickly by clicking on the red lightbulb within IntelliJ and then <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Find JAR on web</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>.</p><p><img loading=lazy src=/find-jar-on-web.png alt="Find JAR on Web"></p><p>Otherwise, you can navigate back to <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>File ‚Üí Project Structure‚Ä¶</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> and add a new library from Maven (the Java package manager).</p><p><img loading=lazy src=/add-library-from-maven.png alt="Add Library from Maven"></p><p>Search for and select the dependency you need to resolve. IntelliJ will download the <code>.jar</code> from Maven and add it to your project.</p><p><img loading=lazy src=/completing-jar-download.png alt="Completing JAR Download"></p><h2 id=6-profit>6. Profit!<a hidden class=anchor aria-hidden=true href=#6-profit>#</a></h2><p>I know it took a bit to get here, but by investing time up front, you are now prepared to find vulnerabilities that simply wouldn‚Äôt be possible otherwise.</p><h3 id=finding-usages>Finding Usages<a hidden class=anchor aria-hidden=true href=#finding-usages>#</a></h3><p>One of the pain points of manual static analysis is the tedious process of tracing user-controllable input through the application. Well, with our current setup, we have made our lives much easier. We can click on any variable, method, or class and find all of its assignments and usages throughout the application. For example, we might want to understand how the class variable <code>m_settings</code> is being used throughout the application:</p><p><img loading=lazy src=/find-usages-usage.png alt="Find Usages Usage"></p><p>IntelliJ&rsquo;s ability to map out all read and write occurrences of a variable in question greatly speeds up manual static analysis.</p><p><img loading=lazy src=/read-and-write-occurrences.png alt="Read and Write Occurrences"></p><h3 id=data-flow-analysis>Data Flow Analysis<a hidden class=anchor aria-hidden=true href=#data-flow-analysis>#</a></h3><p>IntelliJ goes behind just finding usages, though. It can fully map out the flow of data within the application. To do this, we right click on a variable and go to <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Analyze ‚Üí Data Flow to Here‚Ä¶ or Data Flow from Here‚Ä¶</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> Below, we are doing this to understand how the <code>req</code> variable of the <code>doGet()</code> method of an HTTP servlet is being used.</p><p><img loading=lazy src=/data-flow-usage.png alt="Data Flow Usage"></p><p>We can then easily view all the places the <code>req</code> variable is passed into other functions within the rest of the application in one single place. This is extremely useful during static analysis.</p><p><img loading=lazy src=/viewing-data-flow.png alt="Viewing Data Flow"></p><h3 id=sink-to-source-analysis>Sink-to-Source Analysis<a hidden class=anchor aria-hidden=true href=#sink-to-source-analysis>#</a></h3><p>With these tools under our belt, we have to ability to find truly impactful vulnerabilities. We can leverage <strong>source-to-sink analysis</strong>, (also called taint analysis) where we trace the flow of data from dangerous functions back to parameters we control. For a more in-depth definition of source-to-sink analysis, check out one of my previous blog posts: <a href=https://www.mandiant.com/resources/blog/route-sixty-sink-launch>https://www.mandiant.com/resources/blog/route-sixty-sink-launch</a>.</p><p>For example, let‚Äôs say we want to look for <a href=https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html>unsafe deserialization vulnerabilities</a> (they just so happen to be one of my favorite vulnerability classes). We know that a call to <code>java.io.ObjectInputStream::ReadObject()</code> on attacker-controlled data can result in SSRF, file access, or even remote code execution. Let‚Äôs see how to search for Java object deserialization within our application:</p><p>First, enter <strong><strong><strong><strong><strong><strong>‚åò + O</strong></strong></strong></strong></strong></strong> and search for the <code>java.io.ObjectInputStream</code> class:</p><p><img loading=lazy src=/searching-for-object-input-stream.png alt="Searching For ObjectInputStream"></p><p>Identify the <code>readObject()</code> method and view its data flow throughout the application:</p><p><img loading=lazy src=/read-object-data-flow.png alt="Read Object Data Flow"></p><p>We immediately have a detailed call graph leading to our sink. If we can trace it to input that we control as an attacker, (an HTTP parameter, header, etc.) we‚Äôve found a vulnerability!</p><p><img loading=lazy src=/data-flow-results.png alt="Data Flow Results"></p><p>Thanks for reading! Keep an eye out for more security content coming your way soon! Stay safe out there! üîíüíªüë®‚Äçüíª</p></div><footer class=post-footer><ul class=post-tags></ul></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//dillon-franke-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.dillonfrankesecurity.com>Dillon Franke Security</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>